<%- include('../../partials/header') %>

<style>
  .table-responsive {
    overflow-x: auto;
  }

  .table {
    background-color: white;
    border-collapse: collapse;
    width: 100%;
  }

  .table th {
    background-color: #212529;
    color: white;
    font-weight: 500;
    text-align: center;
  }

  .table td, .table th {
    padding: 12px;
    border: 1px solid #dee2e6;
  }

  .table tbody tr:hover {
    background-color: rgba(0, 123, 255, 0.05);
  }

  /* Buttons */
  .action-buttons {
    display: flex;
    gap: 8px;
    justify-content: center;
  }

  .btn-save {
    background-color: #007bff;
    color: white;
    padding: 6px 12px;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    transition: all 0.3s ease;
  }

  .btn-save:hover {
    background-color: #0056b3;
    transform: scale(1.1);
  }
</style>

<!-- Breadcrumbs -->
<nav aria-label="breadcrumb">
  <ol class="breadcrumb">
    <li class="breadcrumb-item"><a href="/">Dashboard</a></li>
    <li class="breadcrumb-item active" aria-current="page">Compliance Notifications</li>
  </ol>
</nav>

<h1 class="mb-4 text-center">Compliance Notifications</h1>

<div class="container">
  <!-- Compliance Notifications -->
  <div class="card p-4 mb-4">
    <h3>Pending Compliance Notifications</h3>
    <div class="table-responsive mt-3">
      <table class="table table-striped">
        <thead>
          <tr>
            <th>#</th>
            <th>Department</th>
            <th>Compliance Issue</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody>
          <% if (notifications && notifications.length > 0) { %>
            <% notifications.forEach((notification, index) => { %>
              <tr>
                <td><%= index + 1 %></td>
                <td><%= notification.Department_Name %></td>
                <td><%= notification.Compliance_Issue %></td>
                <td class="action-buttons">
                  <button class="btn-save" onclick="saveToTracking(<%= notification.Notification_ID %>)">
                    <i class="fas fa-check-circle"></i> Save to Tracking
                  </button>
                </td>
              </tr>
            <% }); %>
          <% } else { %>
            <tr>
              <td colspan="4" class="text-center">No pending compliance notifications</td>
            </tr>
          <% } %>
        </tbody>
      </table>
    </div>
  </div>

  <!-- Compliance Tracking Table -->
  <div class="card p-4">
    <h3>Compliance Tracking</h3>
    <div class="table-responsive mt-3">
      <table class="table table-striped">
        <thead>
          <tr>
            <th>#</th>
            <th>Department</th>
            <th>Compliance Issue</th>
            <th>Status</th>
          </tr>
        </thead>
        <tbody>
          <% if (tracking && tracking.length > 0) { %>
            <% tracking.forEach((track, index) => { %>
              <tr>
                <td><%= index + 1 %></td>
                <td><%= track.Department_Name %></td>
                <td><%= track.Compliance_Issue %></td>
                <td>
                  <select onchange="updateTrackingStatus(<%= track.Tracking_ID %>, this.value)" id="tracking-status-<%= track.Tracking_ID %>">
                    <option value="Pending" <%= track.Status === 'Pending' ? 'selected' : '' %>>Pending</option>
                    <option value="In Progress" <%= track.Status === 'In Progress' ? 'selected' : '' %>>In Progress</option>
                    <option value="Resolved" <%= track.Status === 'Resolved' ? 'selected' : '' %>>Resolved</option>
                    <option value="Escalated" <%= track.Status === 'Escalated' ? 'selected' : '' %>>Escalated</option>
                  </select>
                </td>                
              </tr>
            <% }); %>
          <% } else { %>
            <tr>
              <td colspan="4" class="text-center">No tracked compliance issues</td>
            </tr>
          <% } %>
        </tbody>
      </table>
    </div>
  </div>
</div>

<script>
  async function saveToTracking(notificationId) {
      try {
          const response = await fetch(`/compliance/save-to-tracking`, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ notificationId })
          });
  
          const result = await response.json();
          if (!response.ok) {
              throw new Error(result.message || "Failed to save notification.");
          }
  
          alert(result.message);
          window.location.reload(); // Reload page to reflect changes
      } catch (error) {
          console.error("Error saving notification:", error);
          alert(error.message);
      }
  }

  async function updateTrackingStatus(trackingId, newStatus) {
      try {
          console.log(`Updating Tracking_ID ${trackingId} to Status: ${newStatus}`);

          const response = await fetch(`notification/update`, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ trackingId, newStatus })
          });

          const result = await response.json();

          if (!response.ok) {
              throw new Error(result.message || "Failed to update status.");
          }

          alert(result.message);

          // Update status in UI without reloading
          const statusCell = document.querySelector(`#tracking-status-${trackingId}`);
          if (statusCell) {
              statusCell.innerText = result.updatedStatus;
          }
      } catch (error) {
          console.error("Error updating status:", error);
          alert(error.message);
      }
  }


</script>

<%- include('../../partials/footer') %>
